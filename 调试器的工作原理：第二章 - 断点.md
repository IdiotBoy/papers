## 调试器的工作原理：第二章 - 断点


本文是**调试器的工作原理**系列文章的第二章。阅读本文前，希望读者已经阅读过[第一章](...)。

### 本文简介
笔者将展示一个调试器如何实现断点功能。断点功能是调试中的两大神级功能之一，另一个神级功能是观察指定的变量。第一章已经介绍了调试器的简单功能，但断点的实现依然迷雾重重。阅读完本文，一切都会明朗。

### 软件中断
为了在 x86 架构中实现断点功能，软件中断（又称为陷阱）必不可少。在深入介绍之前，笔者先简要说明两个概念，中断和陷阱。

一个 CPU 会有一个流水式的计算，一个指令接着一个指令[[备注1](#1)]。为了响应异步事件，如输入输出、硬件定时器，CPU 使用了中断。一个硬件中断常常是一个专用的电子信号，绑定着一个响应电路。该电路能激活中断，并使得 CPU 停止当前计算、保存状态，然后跳转到一个预设的地址，该地址便是中断处理程序。当中断处理完成，CPU 恢复到停止前的状态继续运行。

软件中断的原理相似，实现稍有差别。CPU 支持特殊指令，使得软件能模拟中断。当特殊指令被执行，CPU 如同处理中断一般，停止正常计算、保存状态，然后跳转到一个中断处理程序。正是这些软件中断（或陷阱），现代操作系统得以实现一些无法想象的神奇功能，如任务调度、虚拟内存、内存保护、调试跟踪等。

一些编程错误（如除以零）也被 CPU 当做软件中断，并常常当异常处理。这些时候，硬件与软件的界限模糊了，因为非常难以说明异常的源头是硬件或软件。不过这已经不是本文要讨论的问题了，下面还是回到断点。

### int 3 中断理论



[1] 从高层次观察是正确的。落实到具体执行，现在 CPU 用多核并行的执行多条指令，甚至执行顺序得不到保证，即排在流前面的不一定先执行。巧妙的 CPU 设计使得多核并行的运行结果与单核运行一致，所以整体依然可以视为单核执行。